from PyQt6 import QtWidgets, uic, QtCore
from PyQt6.QtWidgets import QWidget, QMessageBox, QApplication
from PyQt6.QtCore import QDate, QTime, pyqtSignal
import sys
import pymysql
import traceback

def exception_hook(extype, value, tb):
    traceback.print_exception(extype, value, tb)
    QMessageBox.critical(None, 'ошибка', str(value))

def fill_table(tw_widget, orders, columns):
    tw_widget.setRowCount(0)
    for row_num, row_data in enumerate(orders):
        tw_widget.insertRow(row_num)
        for col_num, col_name in enumerate(columns):
            value = row_data.get(col_name, '')
            tw_widget.setItem(row_num, col_num, QtWidgets.QTableWidgetItem(str(value)))
def get_connection():
    return pymysql.connect(host='localhost', user='root', password='', database='auto', cursorclass=pymysql.cursors.DictCursor)
class Login(QWidget):
    def __init__(self):
        super().__init__()
        uic.loadUi('login.ui', self)
        self.pb_log.clicked.connect(self.login)
    def login(self):
        login= self.le_log.text()
        password = self.le_pass.text()
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('select * from users where login=%s and password=%s', (login, password))
        user = cursor.fetchone()
        conn.close()
        if not user:
            QMessageBox.warning(self, 'Ошибка', 'Неправильный логин или пароль')
            return
        if user['role'] == 'client':
            client_id = user.get('client_id')
            self.window = Client(client_id)
        elif user['role'] == 'admin':
            self.window = Admin()
        else:
            self.window=Director()
        self.window.show()
        self.close()
class Admin(QWidget):
    closed = pyqtSignal()
    def __init__(self):
        super().__init__()
        uic.loadUi('admin.ui', self)
        self.pb_show.clicked.connect(self.load_orders)
        self.pb_filter.clicked.connect(self.filter)
        self.pb_create.clicked.connect(self.create)
        self.pb_details.clicked.connect(self.show_all)
        self.pb_edit.clicked.connect(self.edit)
        self.load_orders()
        self.load_status()
    def show_all(self):
        selected = self.tw_orders.currentRow()
        if selected < 0:
            return
        order_id = int(self.tw_orders.item(selected, 0).text())
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('select i.order_id, s.name_s, s.price from order_items i left join service s on s.service_id=i.service_id '
                       'where i.order_id = %s', (order_id,))
        orders = cursor.fetchall()
        conn.close()
        columns = ['order_id', 'name_s', 'price']
        fill_table(self.tw_orders, orders, columns)
    def load_status(self):
        self.cb_status.addItem('выберите статус', None)
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('select * from status')
        status = cursor.fetchall()
        for s in status:
            self.cb_status.addItem(s['name_s'], s['idstatus'])
        conn.close()
    def load_orders(self):
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('select o.order_id, c.fio, o.vehicle_id, m.fio as mfio, o.planned_date, o.planned_time, o.status, o.total_cost from orders o '
                       'left join clients c on c.client_id = o.client_id left join mechanics m on m.mechanic_id = o.mechanic_id')
        orders = cursor.fetchall()
        conn.close()
        columns = ['order_id','fio', 'vehicle_id', 'mfio', 'planned_date', 'planned_time', 'status', 'total_cost']
        fill_table(self.tw_orders, orders, columns)
    def filter(self):
        de = self.de.date().toString('yyyy-MM-dd')
        status = self.cb_status.currentText()
        conn = get_connection()
        cursor = conn.cursor()
        sql = '''select c.fio, o.vehicle_id, m.fio, o.planned_date, o.planned_time, o.status, o.total_cost from orders o
        left join clients c on c.client_id = o.client_id left join mechanics m on m.mechanic_id = o.mechanic_id where planned_date=%s'''
        parms = [de]
        if status != 'выберите статус':
            sql += ' and status=%s'
            parms.append(status)
        cursor.execute(sql,parms)
        orders = cursor.fetchall()
        columns = ['fio', 'vehicle_id' 'fio', 'planned_date', 'planned_time', 'status', 'total_cost']
        fill_table(self.tw_orders, orders, columns)
    def create(self):
        self.window = Create()
        self.window.closed.connect(self.load_orders)
        self.window.show()
    def edit(self):
        selected = self.tw_orders.currentRow()
        if selected < 0:
            return
        order_id = int(self.tw_orders.item(selected, 0).text())
        self.window = Edit(order_id)
        self.window.closed.connect(self.load_orders)
        self.window.show()
class Create(QWidget):
    closed = pyqtSignal()
    def __init__(self):
        super().__init__()
        uic.loadUi('create.ui', self)
        self.load_price()
        self.load_mech()
        self.pb_save.clicked.connect(self.save)
    def load_price(self):
        self.cb_price.addItem('выберите услугу', None)
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('select * from service')
        status = cursor.fetchall()
        for s in status:
            self.cb_price.addItem(s['name_s'], s['service_id'])
        conn.close()
    def load_mech(self):
        self.cb_mech.addItem('выберите механика', None)
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('select * from mechanics')
        status = cursor.fetchall()
        for s in status:
            self.cb_mech.addItem(s['fio'], s['mechanic_id'])
        conn.close()
    def save(self):
        fio = self.le_fio.text()
        phone = self.le_phone.text()
        email = self.le_email.text()
        brand = self.le_brand.text()
        model = self.le_model.text()
        year = self.le_year.text()
        vin = self.le_vin.text()
        mileage = self.le_mileage.text()
        de = self.de.date().toString('yyyy-MM-dd')
        cb_price = self.cb_price.currentData()
        cb_mech = self.cb_mech.currentData()
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('select * from clients where fio=%s and phone=%s and email=%s', (fio, phone, email))
        client = cursor.fetchone()
        if client:
            client_id = client.get('client_id')
        else:
            cursor.execute('insert into clients (fio, phone, email) values (%s, %s, %s)', (fio, phone, email))
            client_id = cursor.lastrowid
            conn.commit()
        cursor.execute('select * from vehicles where client_id=%s and brand=%s and model=%s and year=%s and vin=%s',
                       (client_id, brand, model, year, vin))
        vehicle = cursor.fetchone()
        if vehicle:
            vehicle_id = vehicle.get('vehicle_id')
        else:
            cursor.execute('insert into vehicles (brand, model ,year, vin, mileage) values (%s, %s, %s, %s, %s)',
                           (brand, model, year, vin, mileage))
            vehicle_id = cursor.lastrowid
            conn.commit()
        cursor.execute('insert into orders (client_id, vehicle_id, mechanic_id, planned_date, status) values (%s, %s, %s, %s, %s)',
                       (client_id, vehicle_id, cb_mech, de, 'Принят'))
        order_id = cursor.lastrowid
        conn.commit()
        cursor.execute('insert into order_items (order_id, service_id) values (%s, %s)',
                       (order_id, cb_price))
        conn.commit()
        conn.close()
        self.closed.emit()
        self.close()
class Edit(QWidget):
    closed = pyqtSignal()
    def __init__(self, order_id):
        super().__init__()
        uic.loadUi('edit.ui', self)
        self.order_id = order_id
        self.pb_edit.clicked.connect(self.save)
        self.load_status()
        self.load_service()
        self.load_mech()
        self.load_order()
    def load_order(self):
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute(
            '''select o.order_id, c.fio, o.vehicle_id, o.mechanic_id, o.planned_date, o.planned_time, o.status, o.total_cost 
        from orders o left join clients c on c.client_id = o.client_id 
        left join mechanics m on m.mechanic_id = o.mechanic_id where o.order_id = %s''', (self.order_id,))
        order = cursor.fetchone()
        idx = self.cb_status.findData(order['status'])
        if idx >=0:
            self.cb_status.setCurrentIndex(idx)
        idx2 = self.cb_mech.findData(order['mechanic_id'])
        if idx2 >=0:
            self.cb_mech.setCurrentIndex(idx2)
        conn.close()
    def load_status(self):
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('select * from status')
        status = cursor.fetchall()
        for s in status:
            self.cb_status.addItem(s['name_s'], s['idstatus'])
        conn.close()
    def load_mech(self):
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('select * from mechanics')
        status = cursor.fetchall()
        for s in status:
            self.cb_mech.addItem(s['fio'], s['mechanic_id'])
        conn.close()
    def load_service(self):
        self.cb_add.addItem('Добавьте услугу', None)
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('select * from service')
        status = cursor.fetchall()
        for s in status:
            self.cb_add.addItem(s['name_s'], s['service_id'])
        conn.close()
    def save(self):
        add = self.cb_add.currentData()
        mech = self.cb_mech.currentData()
        status = self.cb_status.currentText()
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('update orders set mechanic_id = %s, status=%s where order_id = %s', (mech, status, self.order_id))
        conn.commit()
        cursor.execute('insert  into order_items (order_id, service_id) values (%s, %s)', (self.order_id, add))
        conn.commit()
        conn.close()
        self.closed.emit()
        self.close()

class Client(QWidget):
    closed = pyqtSignal()
    def __init__(self, client_id):
        super().__init__()
        uic.loadUi('client.ui', self)
        self.client_id =client_id
        self.pb_history.clicked.connect(self.history)
        self.pb_show.clicked.connect(self.load_orders)
        self.pb_create.clicked.connect(self. create)
        self.load_orders()
    def load_orders(self):
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute(
            '''select o.vehicle_id, m.fio, o.planned_date, o.planned_time, o.status, o.total_cost from orders o 
            left join mechanics m on m.mechanic_id = o.mechanic_id where status!='Выполнен' and client_id = %s''', (self.client_id,))
        orders = cursor.fetchall()
        conn.close()
        columns = ['vehicle_id' 'fio', 'planned_date', 'planned_time', 'status', 'total_cost']
        fill_table(self.tw_orders, orders, columns)
    def history(self):
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute(
            '''select o.vehicle_id, m.fio, o.planned_date, o.planned_time, o.status, o.total_cost from orders o 
            left join mechanics m on m.mechanic_id = o.mechanic_id where status='Выполнен' and client_id = %s''', (self.client_id,))
        orders = cursor.fetchall()
        conn.close()
        columns = ['vehicle_id' 'fio', 'planned_date', 'planned_time', 'status', 'total_cost']
        fill_table(self.tw_orders, orders, columns)
    def create(self):
        self.window = CreateClient(client_id=self.client_id)
        self.window.closed.connect(self.load_orders)
        self.window.show()
class CreateClient(QWidget):
    closed = pyqtSignal()
    def __init__(self, client_id):
        super().__init__()
        uic.loadUi('create_client.ui', self)
        self.client_id = client_id
        self.load_price()
        self.load_vehicle()
        self.pb_create.clicked.connect(self.save)
    def load_price(self):
        self.cb_price.addItem('выберите услугу', None)
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('select * from service')
        status = cursor.fetchall()
        for s in status:
            self.cb_price.addItem(s['name_s'], s['service_id'])
        conn.close()
    def load_vehicle(self):
        self.cb_vehicle.addItem('выберите автомобиль', None)
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('select * from vehicles where client_id=%s', (self.client_id,))
        status = cursor.fetchall()
        for s in status:
            self.cb_vehicle.addItem(s['brand'], s['vehicle_id'])
        conn.close()
    def save(self):
        vehicle_id = self.cb_vehicle.currentData()
        service = self.cb_price.currentData()
        de = self.de.date().toString('yyyy-MM-dd')
        te = self.te.time().toString('HH:mm:ss')
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('insert into orders (client_id, vehicle_id, planned_date, planned_time, status) '
                       'values (%s, %s, %s, %s, %s)', (self.client_id, vehicle_id, de, te, 'Ожидает'))
        order_id = cursor.lastrowid
        conn.commit()
        cursor.execute('insert into order_items (order_id, service_id) values (%s, %s)',
                       (order_id, service))
        conn.commit()
        conn.close()
        self.closed.emit()
        self.close()

if __name__ == '__main__':
    app =QApplication(sys.argv)
    window = Login()
    window.show()
    sys.excepthook = exception_hook
    sys.exit(app.exec())

