import sys
from PyQt6 import QtWidgets, uic
from PyQt6.QtWidgets import QMainWindow, QApplication, QMessageBox
from PyQt6.QtCore import QDate, QTime
import pymysql
import traceback
from PyQt6 import QtCore


def exepthion_hook(extype, value, tb):
    traceback.print_exception(extype, value, tb)
    QMessageBox.critical(None, 'Ошибка', str(value))

def get_connection():
    return pymysql.connect(
        host='localhost',
        user='root',
        password='',
        database='flower_shop3', cursorclass=pymysql.cursors.DictCursor
    )
def fill_table(table_widget, value, columns):
    table_widget.setRowCount(0)
    for row_num, row_data in enumerate(value):
        table_widget.insertRow(row_num)
        for col_num, col_name in enumerate(columns):
            value = row_data.get(col_name)
            table_widget.setItem(row_num, col_num, QtWidgets.QTableWidgetItem(str(value)))
def date_example(value):
    return QDate.fromString(str(value), 'yyyy-MM-dd') if value else QDate.currentDate()
def time_example(value):
    return QTime.fromString(str(value), 'HH:mm:ss') if value else QTime.currentTime()

class LoginWindow(QtWidgets.QWidget):
    def __init__(self):
        super().__init__()
        uic.loadUi('login.ui', self)
        self.pb_login.clicked.connect(self.login)
        self.le_pass.setEchoMode(QtWidgets.QLineEdit.EchoMode.Password)

    def login(self):
        login = self.le_login.text().strip()
        password = self.le_pass.text().strip()

        if not login or not password:
            QMessageBox.warning(self,'Ошибка','Введите логин или пароль')
            return
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('select * from users where login=%s and password=%s', (login,password))
        user = cursor.fetchone()
        conn.close()
        if not user:
            QMessageBox.warning(self, 'Ошибка', 'Неправильный логин или пароль')
            return
        if user['role'] == 'client':
            client_id = user.get('customer_id')
            self.window = ClientWindow(client_id)
        elif user['role'] == 'seller':
            self.window = SellerWindow()
        else:
            self.window = ManagerWindow()

        self.window.show()
        self.close()
class ManagerWindow(QtWidgets.QWidget):
    def __init__(self):
        super().__init__()
        uic.loadUi('manager.ui', self)
        self.pb_add.clicked.connect(self.add_prod)
        self.pb_report.clicked.connect(self.report)
        self.load_flowers()

    def load_flowers(self):
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('select p.product_id, p.product_name, p.price, i.quantity, i.last_restock_date from products p left join inventory i on '
                       'i.product_id = p.product_id')
        flowers = cursor.fetchall()
        conn.close()
        columns = ['product_id','product_name', 'price', 'quantity', 'last_restock_date']
        fill_table(self.tw_flowers, flowers, columns)
        self.tw_flowers.setColumnHidden(0, True)
    def report(self):
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('select p.price, i.quantity, (p.price*i.quantity) as total from products p left join inventory i on '
                       'i.product_id = p.product_id ')
        products = cursor.fetchall()
        conn.close()
        total_sum = sum(p['total'] for p in products)
        QMessageBox.information(self, 'Отчёт по складу', f'Общая стоимость всех товаров на складе: {total_sum:.2f} р.')
    def add_prod(self):
        selected = self.tw_flowers.currentRow()
        if selected < 0:
            return
        quantity_to_add = int(self.le_add.text())
        product_id = int(self.tw_flowers.item(selected, 0).text())
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('select quantity from inventory where product_id=%s ', (product_id,))
        row = cursor.fetchone()
        if row:
            cursor.execute('update inventory set quantity = quantity + %s, last_restock_date = %s where product_id = %s', (quantity_to_add, QDate.currentDate().toString('yyyy-MM-dd'), product_id))
        else:
            cursor.execute('insert into inventory (product_id, quantity, last_restock_date )values (%s, %s, %s)',
                           (product_id, quantity_to_add, QDate.currentDate().toString('yyyy-MM-dd')))
        conn.commit()
        conn.close()
        self.load_flowers()
        QMessageBox.information(self,'Готово','Склад пополнен')

class SellerWindow(QtWidgets.QWidget):
    closed = QtCore.pyqtSignal()
    def __init__(self):
        super().__init__()
        uic.loadUi('seller.ui', self)
        self.pb_delete.clicked.connect(self.delete)
        self.pb_orders.clicked.connect(self.load_orders)
        self.pb_flowers.clicked.connect(self.load_flowers)
        self.pb_edit.clicked.connect(self.edit)
        self.pb_create.clicked.connect(self.create_order)
        self.pb_filter.clicked.connect(self.filter)
        self.load_orders()
        self.load_flowers()
    def load_orders(self):
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute("SELECT o.order_id, c.full_name, o.delivery_date, o.delivery_time_from, o.delivery_time_to,"
                       "o.delivery_address, o.status, o.total_amount, o.payment_method, e.full_name FROM orders o "
                       "left join customers c on c.customer_id = o.customer_id left join employee e on e.employee_id = o.employee_id")
        orders = cursor.fetchall()
        conn.close()
        columns = ['order_id','full_name', 'delivery_date', 'delivery_time_from', 'delivery_time_to',
                   'delivery_address', 'status', 'total_amount', 'payment_method', 'full_name']
        fill_table(self.tw_orders, orders, columns)
    def load_flowers(self):
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('select p.product_name, p.price, i.quantity from products p left join inventory i on '
                       'i.product_id = p.product_id')
        flowers = cursor.fetchall()
        conn.close()
        columns = ['product_name', 'price', 'quantity']
        fill_table(self.tw_flowers, flowers, columns)
    def delete(self):
        selected = self.tw_orders.currentRow()
        if selected < 0:
            return
        order_id = int(self.tw_orders.item(selected, 0).text())
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('delete from orders where order_id = %s', (order_id,))
        conn.commit()
        conn.close()
        self.load_orders()
    def filter(self):
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('select p.product_name, p.price, i.quantity from products p left join inventory i on '
                       'i.product_id = p.product_id order by quantity DESC')
        flowers = cursor.fetchall()
        conn.close()
        columns = ['product_name', 'price', 'quantity']
        fill_table(self.tw_flowers, flowers, columns)
    def create_order(self):
        self.window = CreateOrder()
        self.window.closed.connect(self.load_orders)
        self.window.show()
    def edit(self):
        selected = self.tw_orders.currentRow()
        if selected < 0:
            return
        order_id = int(self.tw_orders.item(selected, 0).text())
        self.window = EditorWindow(order_id)
        self.closed.connect(self.load_orders)
        self.window.show()

class EditorWindow(QtWidgets.QWidget):
    closed = QtCore.pyqtSignal()
    def __init__(self, order_id):
        super().__init__()
        uic.loadUi('edit.ui', self)
        self.order_id = order_id
        self.pb_create.clicked.connect(self.save)
        self.load_employee()
        self.load_status()
        self.load_order()
    def load_status(self):
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('select * from status')
        products = cursor.fetchall()
        for p in products:
            self.cb_status.addItem(p['name'])
        conn.close()
    def load_employee(self):
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('select * from employee')
        products = cursor.fetchall()
        for p in products:
            self.cb_emp.addItem(p['full_name'], p['employee_id'])
        conn.close()
    def load_order(self):
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute("SELECT o.order_id, o.delivery_date, o.delivery_time_from, o.delivery_time_to,"
                       "o.delivery_address, o.status, o.payment_method, e.full_name FROM orders o "
                       "left join employee e on e.employee_id = o.employee_id where o.order_id = %s",
                       (self.order_id,))
        order = cursor.fetchone()
        conn.close()
        self.de_delivery.setDate(date_example(order['delivery_date']))
        self.te_from.setTime(time_example(order['delivery_time_from']))
        self.te_to.setTime(time_example(order['delivery_time_to']))
        self.le_address.setText(order['delivery_address'])
        self.cb_status.setCurrentText(order['status'])
        self.le_payment.setText(order['payment_method'])
        self.cb_emp.setCurrentText(order['full_name'])
    def save(self):
        conn = get_connection()
        cursor = conn.cursor()
        de_delivery = self.de_delivery.date().toString('yyyy-MM-dd')
        time_to = self.te_to.time().toString('HH:mm:ss')
        time_from = self.te_from.time().toString('HH:mm:ss')
        address = self.le_address.text()
        payment = self.le_payment.text()
        emp = self.cb_emp.currentData()
        status = self.cb_status.currentText()
        cursor.execute('update orders set delivery_date=%s, delivery_time_from=%s, delivery_time_to=%s, '
                       'delivery_address=%s, status=%s, payment_method=%s, employee_id=%s where order_id=%s',
                       (de_delivery, time_from, time_to, address, status,payment,emp, self.order_id))
        conn.commit()
        conn.close()
        self.closed.emit()
        self.close()


class CreateOrder(QtWidgets.QWidget):
    closed = QtCore.pyqtSignal()
    def __init__(self):
        super().__init__()
        uic.loadUi('create_order.ui', self)
        self.pb_create.clicked.connect(self.create)
        self.load_products()
        self.load_status()
        self.load_employee()
    def load_products(self):
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('select * from products')
        products = cursor.fetchall()
        for p in products:
            self.cb_product.addItem(p['product_name'], p['product_id'])
        conn.close()
    def load_status(self):
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('select * from status')
        products = cursor.fetchall()
        for p in products:
            self.cb_status.addItem(p['name'])
        conn.close()
    def load_employee(self):
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('select * from employee')
        products = cursor.fetchall()
        for p in products:
            self.cb_emp.addItem(p['full_name'], p['employee_id'])
        conn.close()
    def create(self):
        fio = self.le_fio.text()
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('select customer_id, full_name from customers where full_name = %s', (fio,))
        customer = cursor.fetchone()
        if not customer:
            cursor.execute('insert into customers (full_name) values (%s)', (fio,))
            client_id = cursor.lastrowid
        elif customer['full_name'] == fio:
            client_id = customer['customer_id']
        else:
            cursor.execute('insert into customers (full_name) values (%s)', (fio,))
            client_id = cursor.lastrowid
        conn.commit()

        product = self.cb_product.currentData()
        de_delivery = self.de_delivery.date().toString('yyyy-MM-dd')
        time_to = self.te_to.time().toString('HH:mm:ss')
        time_from = self.te_from.time().toString('HH:mm:ss')
        address = self.le_address.text()
        price = float(self.le_price.text())
        payment = self.le_payment.text()
        emp = self.cb_emp.currentData()
        status = self.cb_status.currentText()
        cursor.execute('insert into orders(customer_id,order_date,delivery_date, delivery_time_from, delivery_time_to, '
                       'delivery_address, status, total_amount, payment_method, employee_id) values (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s)',
                       (client_id, QDate.currentDate().toString('yyyy-MM-dd'),
                        de_delivery, time_from, time_to, address, status, price, payment,emp))
        order_id = cursor.lastrowid
        conn.commit()
        cursor.execute('insert into order_items (order_id, product_id) values (%s, %s)', (order_id, product))
        conn.commit()
        cursor.close()
        self.closed.emit()
        self.close()

class ClientWindow(QtWidgets.QWidget):
    closed = QtCore.pyqtSignal()
    def __init__(self, client_id):
        super().__init__()
        uic.loadUi('client.ui', self)
        self.client_id = client_id
        self.pb_create.clicked.connect(self.create)
        self.pb_refrech.clicked.connect(self.load_ordersc)
        self.load_ordersc()
        self.load_flowers()
    def load_ordersc(self):
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute("SELECT o.delivery_date, o.delivery_time_from, o.delivery_time_to,"
                       "o.delivery_address, o.status, o.total_amount, o.payment_method FROM orders o")
        orders = cursor.fetchall()
        conn.close()
        columns = ['delivery_date', 'delivery_time_from', 'delivery_time_to',
                   'delivery_address', 'status', 'total_amount', 'payment_method']
        fill_table(self.tw_orders, orders, columns)
    def load_flowers(self):
            conn = get_connection()
            cursor = conn.cursor()
            cursor.execute('select product_name, price, description from products')
            flowers = cursor.fetchall()
            conn.close()
            columns = ['product_name', 'price', 'description']
            fill_table(self.tw_flowers, flowers, columns)
    def create(self):
        self.window = CreateOrderClient(client_id=self.client_id)
        self.closed.connect(self.load_ordersc)
        self.window.show()

class CreateOrderClient(QtWidgets.QWidget):
    closed = QtCore.pyqtSignal()
    def __init__(self, client_id):
        super().__init__()
        uic.loadUi('create_order_client.ui', self)
        self.client_id = client_id
        self.load_products()
        self.pb_create.clicked.connect(self.create_order)

    def load_products(self):
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('select * from products')
        products = cursor.fetchall()
        for p in products:
            self.cb_product.addItem(p['product_name'], p['product_id'])
        conn.close()

    def create_order(self):
        conn = get_connection()
        cursor = conn.cursor()
        product_id = self.cb_product.currentData()
        de_delivery = self.de_delivery.date().toString('yyyy-MM-dd')
        time_to = self.te_to.time().toString('HH:mm:ss')
        time_from = self.te_from.time().toString('HH:mm:ss')
        address = self.le_address.text()
        payment = self.le_payment.text()
        cursor.execute('select product_id, price from products where product_id = %s ', (product_id,))
        product = cursor.fetchone()
        price = float(product['price']) if product['price'] else 0.0
        cursor.execute('insert into orders(customer_id,order_date,delivery_date, delivery_time_from, delivery_time_to, '
                       'delivery_address, status, total_amount, payment_method, employee_id) values (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s)',
                       (self.client_id, QDate.currentDate().toString('yyyy-MM-dd'),
                        de_delivery, time_from, time_to, address, 'Создан', price, payment, 1))
        order_id = cursor.lastrowid
        cursor.execute('insert into order_items (order_id, product_id) values (%s, %s)',(order_id, product_id))
        conn.commit()
        conn.close()
        self.closed.emit()
        self.close()

if __name__ == '__main__':
    app = QtWidgets.QApplication(sys.argv)
    window = LoginWindow()
    window.show()
    sys.excepthook = exepthion_hook
    sys.exit(app.exec())
