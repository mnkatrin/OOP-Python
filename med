from multiprocessing.connection import Client

import pymysql
from PyQt6 import QtWidgets, uic, QtCore
from PyQt6.QtWidgets import QWidget, QMessageBox, QApplication
from PyQt6.QtCore import QDate, QTime, pyqtSignal
import sys
import traceback

def exception_hook(extype, value, tb):
    traceback.print_exception(extype,value,tb)
    QMessageBox.critical(None, 'error', str(value))
def get_connection():
    return pymysql.connect(host='localhost', user='root', password='', database='med', cursorclass=pymysql.cursors.DictCursor)
def fill_table(tw_widget, orders, columns):
    tw_widget.setRowCount(0)
    for row_num, row_data in enumerate(orders):
        tw_widget.insertRow(row_num)
        for col_num, col_name in enumerate(columns):
            value = row_data.get(col_name, '')
            tw_widget.setItem(row_num,col_num, QtWidgets.QTableWidgetItem(str(value)))
class Login(QWidget):
    def __init__(self):
        super().__init__()
        uic.loadUi('login.ui', self)
        self.pb_log.clicked.connect(self.login)
    def login(self):
        login = self.le_log.text()
        password = self.le_pass.text()
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('select * from users where login=%s and password=%s', (login, password))
        user = cursor.fetchone()
        conn.close()
        if not user:
            QMessageBox.warning(self,'error', 'Неправильный логин или пароль')
            return
        if user['role'] == 'client':
            client_id = user.get('client_id')
            self.window = Client(client_id)
        else:
            self.window = Admin()
        self.window.show()
        self.close()
class Admin(QWidget):
    closed = pyqtSignal()
    def __init__(self):
        super().__init__()
        uic.loadUi('admin.ui', self)
        self.pb_filter.clicked.connect(self.filter)
        self.pb_show.clicked.connect(self.load_orders)
        self.pb_create.clicked.connect(self.create)
        self.pb_record.clicked.connect(self.record)
        self.pb_pay.clicked.connect(self.pay)
        self.pb_delete.clicked.connect(self.delete)
        self.load_orders()
        self.load_status()

    def load_orders(self):
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('select a.appoint_id, c.fio as client, d.fio, a.date, a.time, a.type, a.status, a.price '
                       'from appoint a left join clients c on c.client_id left join doctors d on d.doctor_id = a.doctor_id')
        orders =cursor.fetchall()
        conn.close()
        columns = ['appoint_id', 'client', 'fio', 'date', 'time', 'type', 'status', 'price']
        fill_table(self.tw_orders, orders, columns)

    def load_status(self):
        self.cb_status.addItem('Выберете статус', None)
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('select * from status')
        status = cursor.fetchall()
        for s in status:
            self.cb_status.addItem(s['name_s'], s['idstatus'])
        conn.close()
    def filter(self):
        cb = self.cb_status.currentText()
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('select a.appoint_id, c.fio as client, d.fio, a.date, a.time, a.type, a.status, a.price '
                       'from appoint a left join clients c on c.client_id left join doctors d on d.doctor_id = a.doctor_id '
                       'where status=%s', (cb,))
        orders =cursor.fetchall()
        conn.close()
        columns = ['appoint_id', 'client', 'fio', 'date', 'time', 'type','status', 'price']
        fill_table(self.tw_orders, orders, columns)
    def delete(self):
        selected = self.tw_orders.currentRow()
        if selected <0:
            return
        order_id = int(self.tw_orders.item(selected, 0).text())
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('update appoint set status=%s where appoint_id=%s', ('Отменен', order_id))
        conn.commit()
        conn.close()
        self.load_orders()
    def create(self):
        self.window = Create()
        self.window.show()
    def record(self):
        self.window = Record()
        self.window.closed.connect(self.load_orders)
        self.window.show()
    def pay(self):
        selected = self.tw_orders.currentRow()
        if selected < 0:
            return
        order_id = int(self.tw_orders.item(selected, 0).text())
        self.window = Pay(order_id)
        self.window.closed.connect(self.load_orders)
        self.window.show()

class Pay(QWidget):
    closed = pyqtSignal()
    def __init__(self, order_id):
        super().__init__()
        uic.loadUi('pay.ui', self)
        self.order_id = order_id
        self.pb_pay.clicked.connect(self.pay)
        self.cb_pay.currentIndexChanged.connect(self.load_order)
        self.load_order()
        self.load_pay()
    def load_order(self):
        conn = get_connection()
        cursor = conn.cursor()
        method = self.cb_pay.currentText().strip()
        if method in ('Наличные', 'Карта'):
            cursor.execute('select * from payment1 where appoint_id = %s', (self.order_id,))
            pay = cursor.fetchone()
            self.le_price.setText(str(pay['price']))
        else:
            self.le_price.setText('Нет стоимости')
        self.le_price.setEnabled(False)
        conn.close()
    def load_pay(self):
        self.cb_pay.addItem('Выберете тип оплаты', None)
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('select * from payment')
        status = cursor.fetchall()
        for s in status:
            self.cb_pay.addItem(s['name_p'], s['idpayment'])
        conn.close()
    def pay(self):
        cb_pay = self.cb_pay.currentText()
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('update payment1 set status=%s, method=%s where appoint_id=%s', ('Оплачен', cb_pay, self.order_id))
        conn.commit()
        conn.close()
        self.closed.emit()
        self.close()

class Record(QWidget):
    closed = pyqtSignal()
    def __init__(self):
        super().__init__()
        uic.loadUi('report.ui', self)
        self.pb_save.clicked.connect(self.save)
        self.load_clients()
        self.load_spec()
        self.load_doctors()
        self.load_type()
        self.load_service()
        self.cb_doctor.addItem('Выберите доктора', None)
        self.cb_spec.currentIndexChanged.connect(self.load_doctors)
    def load_spec(self):
        self.cb_spec.addItem('Выберете специализацию', None)
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('select * from spec')
        status = cursor.fetchall()
        for s in status:
            self.cb_spec.addItem(s['name_s'], s['idspec'])
        conn.close()
    def load_doctors(self):
        self.cb_doctor.clear()
        cb = self.cb_spec.currentText()
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('select * from doctors where spec=%s', (cb,))
        status = cursor.fetchall()
        for s in status:
            self.cb_doctor.addItem(s['fio'], s['doctor_id'])
        conn.close()
    def load_type(self):
        self.cb_type.addItem('Выберете тип приема', None)
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('select * from type_police')
        status = cursor.fetchall()
        for s in status:
            self.cb_type.addItem(s['name_p'], s['idtype_police'])
        conn.close()
    def load_clients(self):
        self.cb_client.addItem('Выберете клиента', None)
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('select * from clients')
        status = cursor.fetchall()
        for s in status:
            self.cb_client.addItem(s['fio'], s['client_id'])
        conn.close()
    def load_service(self):
        self.cb_servcie.addItem('Выберете услугу', None)
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('select * from service')
        status = cursor.fetchall()
        for s in status:
            self.cb_servcie.addItem(s['name_s'], s['service_id'])
        conn.close()
    def save(self):
        doc = self.cb_doctor.currentData()
        client_id = self.cb_client.currentData()
        de = self.de.date().toString('yyyy-MM-dd')
        te = self.te.time().toString('HH:mm:ss')
        type_p = self.cb_type.currentText()
        service = self.cb_servcie.currentData()
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('insert into appoint (client_id, doctor_id, date, time, type, status) values (%s, %s, %s, %s, %s, %s)',
                       (client_id, doc, de, te, type_p, 'Записан'))
        appoint_id = cursor.lastrowid
        conn.commit()
        cursor.execute('insert into payment1 (appoint_id, client_id, doctor_id, service_id) values (%s, %s, %s, %s)',
                       (appoint_id, client_id, doc, service))
        conn.commit()
        conn.close()
        self.closed.emit()
        self.close()

class Create(QWidget):
    def __init__(self):
        super().__init__()
        uic.loadUi('create.ui', self)
        self.pb_save.clicked.connect(self.save)
        self.load_gender()
        self.load_type()
    def load_gender(self):
        self.cb_gender.addItem('Выберете пол', None)
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('select * from gender')
        status = cursor.fetchall()
        for s in status:
            self.cb_gender.addItem(s['name_g'], s['idgender'])
        conn.close()
    def load_type(self):
        self.cb_type.addItem('Выберете тип полиса', None)
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('select * from type_police')
        status = cursor.fetchall()
        for s in status:
            self.cb_type.addItem(s['name_p'], s['idtype_police'])
        conn.close()
    def save(self):
        fio = self.le_fio.text()
        gen = self.cb_gender.currentText()
        address = self.le_address.text()
        phone = self.le_phone.text()
        email = self.le_email.text()
        seria = self.le_seria.text()
        number = self.le_number.text()
        police = self.le_police.text()
        type_p = self.cb_type.currentText()
        company = self.le_company.text()
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('insert into clients (fio, gender, address, phone, email, seria, number, number_police, type_police, company) values(%s,%s,%s,%s,%s,%s,%s,%s,%s,%s)',
                       (fio, gen, address, phone, email, seria, number, police, type_p, company))
        conn.commit()
        conn.close()
        self.close()
class Client(QWidget):
    def __init__(self, client_id):
        super().__init__()
        uic.loadUi('client.ui', self)
        self.client_id = client_id
        self.pb_show.clicked.connect(self.load_doctors)
        self.pb_filter.clicked.connect(self.filter)
        self.pb_history.clicked.connect(self.history)
        self.pb_all.clicked.connect(self.load_orders)
        self.pb_record.clicked.connect(self.create)
        self.pb_delete.clicked.connect(self.delete)
        self.load_orders()
        self.load_doctors()
        self.load_spec()

    def load_orders(self):
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('select a.appoint_id, d.fio, a.date, a.time, a.type, a.status, a.price '
                       'from appoint a left join doctors d on d.doctor_id = a.doctor_id where client_id=%s',
                       (self.client_id,))
        orders = cursor.fetchall()
        conn.close()
        columns = ['appoint_id','fio', 'date', 'time', 'type', 'status', 'price']
        fill_table(self.tw_orders, orders, columns)
        self.tw_orders.setColumnHidden(0, True)
    def load_doctors(self):
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('select fio, spec from doctors')
        orders = cursor.fetchall()
        conn.close()
        columns = ['fio', 'spec']
        fill_table(self.tw_doctors, orders, columns)
    def load_spec(self):
        self.cb_spec.addItem('Выберете специализацию', None)
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('select * from spec')
        status = cursor.fetchall()
        for s in status:
            self.cb_spec.addItem(s['name_s'], s['idspec'])
        conn.close()
    def filter(self):
        cb = self.cb_spec.currentText()
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('select * from doctors where spec=%s', (cb,))
        orders = cursor.fetchall()
        conn.close()
        columns = ['fio', 'spec']
        fill_table(self.tw_doctors, orders, columns)
    def delete(self):
        selected = self.tw_orders.currentRow()
        if selected <0:
            return
        order_id = int(self.tw_orders.item(selected, 0).text())
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('update appoint set status=%s where appoint_id=%s', ('Отменен', order_id))
        conn.commit()
        conn.close()
        self.load_orders()
    def history(self):
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('''select a.appoint_id, d.fio, a.date, a.time, a.type, a.status, a.price 
        from appoint a left join doctors d on d.doctor_id = a.doctor_id 
        where a.status = 'Выполнен' and client_id = %s ''', (self.client_id,))
        orders = cursor.fetchall()
        conn.close()
        columns = ['appoint_id','fio', 'date', 'time', 'type', 'status', 'price']
        fill_table(self.tw_orders, orders, columns)
    def create(self):
        self.window = CreateClient(client_id=self.client_id)
        self.window.closed.connect(self.load_orders)
        self.window.show()
class CreateClient(QWidget):
    closed = pyqtSignal()
    def __init__(self,client_id):
        super().__init__()
        uic.loadUi('create_client.ui', self)
        self.client_id = client_id
        self.pb_save.clicked.connect(self.save)
        self.load_spec()
        self.load_doctors()
        self.load_type()
        self.load_service()
        self.cb_doctor.addItem('Выберите доктора', None)
        self.cb_spec.currentIndexChanged.connect(self.load_doctors)

    def load_spec(self):
        self.cb_spec.addItem('Выберете специализацию', None)
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('select * from spec')
        status = cursor.fetchall()
        for s in status:
            self.cb_spec.addItem(s['name_s'], s['idspec'])
        conn.close()

    def load_doctors(self):
        self.cb_doctor.clear()
        cb = self.cb_spec.currentText()
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('select * from doctors where spec=%s', (cb,))
        status = cursor.fetchall()
        for s in status:
            self.cb_doctor.addItem(s['fio'], s['doctor_id'])
        conn.close()

    def load_type(self):
        self.cb_type.addItem('Выберете тип приема', None)
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('select * from type_police')
        status = cursor.fetchall()
        for s in status:
            self.cb_type.addItem(s['name_p'], s['idtype_police'])
        conn.close()

    def load_service(self):
        self.cb_servcie.addItem('Выберете услугу', None)
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute('select * from service')
        status = cursor.fetchall()
        for s in status:
            self.cb_servcie.addItem(s['name_s'], s['service_id'])
        conn.close()

    def save(self):
        doc = self.cb_doctor.currentData()
        de = self.de.date().toString('yyyy-MM-dd')
        te = self.te.time().toString('HH:mm:ss')
        type_p = self.cb_type.currentText()
        service = self.cb_servcie.currentData()
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute(
            'insert into appoint (client_id, doctor_id, date, time, type, status) values (%s, %s, %s, %s, %s, %s)',
            (self.client_id, doc, de, te, type_p, 'Записан'))
        conn.commit()
        cursor.execute('insert into payment1 (client_id, doctor_id, service_id) values (%s, %s, %s)',
                       (self.client_id, doc, service))
        conn.commit()
        conn.close()
        self.closed.emit()
        self.close()

if __name__ == '__main__':
    app = QApplication(sys.argv)
    window = Login()
    window.show()
    sys.excepthook = exception_hook
    sys.exit(app.exec())
